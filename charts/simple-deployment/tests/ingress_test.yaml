suite: Ingress host tests
templates:
- "ingress.yaml"
tests:

  - it: "1: Should set nginx-private and cloudflare-dns01-issuer when private host is set."
    set:
      service.enable: true
      deployment.container.containerPort: 8080
      ingress.enable: true
      ingress:
        isPrivate: true
        host: "example.test.ok.dk"
    asserts:
      - equal:
          path: "spec.ingressClassName"
          value: "nginx-private"
      - equal:
          path: "metadata.annotations['cert-manager.io/cluster-issuer']"
          value: "cloudflare-dns01-issuer"

  - it: "2: Should set nginx-public and cloudflare-dns01-issuer when public host is set."
    set:
      service.enable: true 
      deployment.container.containerPort: 8080
      ingress.enable: true
      ingress:
        isPrivate: false
        host: "example.test.ok.dk"
    asserts:
      - equal:
          path: "spec.ingressClassName"
          value: "nginx-public"
      - equal:
          path: "metadata.annotations['cert-manager.io/cluster-issuer']"
          value: "cloudflare-dns01-issuer"

  - it: "3: Should set nginx-private and cloudflare-dns01-issuer when implicit private host is set."
    set:
      service.enable: true
      deployment.container.containerPort: 8080
      ingress.enable: true
      ingress:
        host: "example.test.ok.dk"
    asserts:
      - equal:
          path: "spec.ingressClassName"
          value: "nginx-private"
      - equal:
          path: "metadata.annotations['cert-manager.io/cluster-issuer']"
          value: "cloudflare-dns01-issuer"

  - it: "5: Should set nginx and nginx-http01 when explicit public host in cloud is set."
    set:
      service.enable: true
      deployment.container.containerPort: 8080
      ingress.enable: true
      ingress:
        isPrivate: false
        host: "example.test.okcloud.dk"
    asserts:
      - equal:
          path: "spec.ingressClassName"
          value: "nginx"
      - equal:
          path: "metadata.annotations['cert-manager.io/cluster-issuer']"
          value: "nginx-http01"

  - it: "6: Should set nginx and nginx-http01 when implicit public host in cloud is set."
    set:
      service.enable: true
      deployment.container.containerPort: 8080
      ingress.enable: true
      ingress:
        host: "example.test.okcloud.dk"
    asserts:
      - equal:
          path: "spec.ingressClassName"
          value: "nginx"
      - equal:
          path: "metadata.annotations['cert-manager.io/cluster-issuer']"
          value: "nginx-http01"

  - it: "7: Should not allow private service in cloud. We expect a failed template."
    set:
      service.enable: true
      deployment.container.containerPort: 8080
      ingress.enable: true
      ingress:
        isPrivate: true
        host: "example.test.okcloud.dk"
    asserts:
      - failedTemplate:
        errorMessage: "Services hosted in cloud are public only."

  - it: "8: Should not allow a domain in host we do not know."
    set:
      service.enable: true
      deployment.container.containerPort: 8080
      ingress.enable: true
      ingress:
        isPrivate: true
        host: "example.blahblah.com"
    asserts:
      - failedTemplate:
        errorMessage: "Parent domain not recognized."
